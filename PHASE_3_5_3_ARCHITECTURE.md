# ğŸ—ï¸ PHASE 3.5.3: Complete Architecture Overview

## System Diagram: WebSocket Real-Time ETo Calculation

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         EVAonline - Real-Time ETo                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸŒ FRONTEND (Dash/React)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ app.py - Application Root                                            â”‚  â”‚
â”‚  â”‚ â”œâ”€ dcc.Store('selected-location')                                    â”‚  â”‚
â”‚  â”‚ â”œâ”€ dcc.Store('calculation-state') â† NEW âœ¨                           â”‚  â”‚
â”‚  â”‚ â”œâ”€ dcc.Interval('websocket-interval', interval=2000ms) â† NEW âœ¨      â”‚  â”‚
â”‚  â”‚ â””â”€ render_page_content()                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â–²                                           â”‚
â”‚                                 â”‚ Routes                                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚                       â”‚                       â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Home Page       â”‚     â”‚ ETo Page          â”‚   â”‚ About Page      â”‚        â”‚
â”‚  â”‚ (world_map_     â”‚     â”‚ (dash_eto.py)     â”‚   â”‚ (about.py)      â”‚        â”‚
â”‚  â”‚  tabs.py)       â”‚     â”‚                   â”‚   â”‚                 â”‚        â”‚
â”‚  â”‚                 â”‚     â”‚ DatePicker        â”‚   â”‚                 â”‚        â”‚
â”‚  â”‚ â€¢ Leaflet map   â”‚     â”‚ SourceSelector    â”‚   â”‚                 â”‚        â”‚
â”‚  â”‚ â€¢ Click handler â”‚     â”‚ Calculate button  â”‚   â”‚                 â”‚        â”‚
â”‚  â”‚ â€¢ Modal result  â”‚     â”‚ Results display   â”‚   â”‚                 â”‚        â”‚
â”‚  â”‚ â€¢ result-modal  â”‚     â”‚                   â”‚   â”‚                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚        â”‚                                                                    â”‚
â”‚        â”‚ (Callback ID: 'calc-eto-today-btn')                               â”‚
â”‚        â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ eto_callbacks.py - Event Handlers                                  â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚ â”Œâ”€ Callback 1: calc_eto_today()                                   â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ Input: 'calc-eto-today-btn' (n_clicks)                      â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ Input: 'close-modal' (n_clicks)                             â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ Input: 'websocket-interval' (n_intervals) â† NEW âœ¨          â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ State: 'selected-location'                                  â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ State: 'calculation-state' â† NEW âœ¨                         â”‚    â”‚
â”‚  â”‚ â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ CASE 1: Close modal                                         â”‚    â”‚
â”‚  â”‚ â”‚  â”‚  â””â”€ _ws_manager.disconnect(task_id)                         â”‚    â”‚
â”‚  â”‚ â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ CASE 2: Calculate button clicked                            â”‚    â”‚
â”‚  â”‚ â”‚  â”‚  â”œâ”€ POST /internal/eto/eto_calculate                         â”‚    â”‚
â”‚  â”‚ â”‚  â”‚  â”œâ”€ Get task_id from response â† CHANGED âœ¨                   â”‚    â”‚
â”‚  â”‚ â”‚  â”‚  â”œâ”€ _ws_manager.connect_sync(task_id)                        â”‚    â”‚
â”‚  â”‚ â”‚  â”‚  â”œâ”€ Create ProgressCard component                            â”‚    â”‚
â”‚  â”‚ â”‚  â”‚  â””â”€ Return modal open                                        â”‚    â”‚
â”‚  â”‚ â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ â”‚  â””â”€ CASE 3: Interval triggered (every 2s)                       â”‚    â”‚
â”‚  â”‚ â”‚     â”œâ”€ Get latest message: _ws_manager.get_latest_message()     â”‚    â”‚
â”‚  â”‚ â”‚     â”œâ”€ Update calc_state with progress/step                     â”‚    â”‚
â”‚  â”‚ â”‚     â”œâ”€ Update ProgressCard UI                                   â”‚    â”‚
â”‚  â”‚ â”‚     â””â”€ Return updated modal body                                â”‚    â”‚
â”‚  â”‚ â”‚                                                                 â”‚    â”‚
â”‚  â”‚ â””â”€ Callback 2: calc_eto_period()                                  â”‚    â”‚
â”‚  â”‚    â””â”€ Redirect to /eto page                                       â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚      â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ websocket_handler.py - WebSocket Manager â† NEW FILE âœ¨             â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚ â”Œâ”€ WebSocketConnectionManager                                     â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ connect_sync(task_id, on_message) â† Spawns thread           â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ get_latest_message(task_id)                                 â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ get_messages(task_id)                                       â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ get_status(task_id)                                         â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ disconnect(task_id)                                         â”‚    â”‚
â”‚  â”‚ â”‚  â””â”€ disconnect_all()                                            â”‚    â”‚
â”‚  â”‚ â”‚                                                                  â”‚    â”‚
â”‚  â”‚ â””â”€ Background Thread (per connection)                             â”‚    â”‚
â”‚  â”‚    â”œâ”€ Connect: ws://localhost:8000/ws/task_status/{task_id}       â”‚    â”‚
â”‚  â”‚    â”œâ”€ Listen for messages                                         â”‚    â”‚
â”‚  â”‚    â”œâ”€ Parse JSON â†’ WebSocketMessage objects                       â”‚    â”‚
â”‚  â”‚    â”œâ”€ Store in thread-safe queue                                  â”‚    â”‚
â”‚  â”‚    â””â”€ Auto-disconnect on SUCCESS/ERROR/TIMEOUT                    â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚      â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ progress_card.py - UI Components                                   â”‚    â”‚
â”‚  â”‚                                                                    â”‚    â”‚
â”‚  â”‚ â”Œâ”€ ProgressCard.create()                                          â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ StatusBadge (PROCESSING ğŸ”µ / SUCCESS âœ… / ERROR âŒ)          â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ ProgressBar (0-100% animated)                               â”‚    â”‚
â”‚  â”‚ â”‚  â”œâ”€ ProcessingStatus (Step N/M: description)                    â”‚    â”‚
â”‚  â”‚ â”‚  â””â”€ ResultsDisplay (table with ETo results)                     â”‚    â”‚
â”‚  â”‚ â”‚                                                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    (HTTP POST + WebSocket upgrade)
                                    â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¼â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âš™ï¸ BACKEND (FastAPI + Celery)                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py - Application Entry                                                â”‚
â”‚ â”œâ”€ FastAPI app instance                                                    â”‚
â”‚ â”œâ”€ Mount Dash app (at /dashboard)                                          â”‚
â”‚ â”œâ”€ CORS middleware                                                         â”‚
â”‚ â””â”€ Error handlers                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”˜
                                        â–²
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ API Routes           â”‚ â”‚ WebSocket Service â”‚ â”‚ Background Tasks â”‚
        â”‚ (eto_routes.py)      â”‚ â”‚ (websocket_       â”‚ â”‚ (Celery)         â”‚
        â”‚                      â”‚ â”‚  service.py)      â”‚ â”‚                  â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                   â”‚ â”‚ calculate_eto_   â”‚
        â”‚ â”‚ POST /internal/  â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ pipeline.py      â”‚
        â”‚ â”‚ eto/eto_calculateâ”‚ â”‚ â”‚ â”‚ /ws/task_     â”‚ â”‚ â”‚                  â”‚
        â”‚ â”‚                  â”‚ â”‚ â”‚ â”‚ status/       â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚ â”‚ 1. Validate      â”‚ â”‚ â”‚ â”‚ {task_id}     â”‚ â”‚ â”‚ â”‚ 1. Download  â”‚ â”‚
        â”‚ â”‚ 2. Apply Celery  â”‚ â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ â”‚    data      â”‚ â”‚
        â”‚ â”‚    task (async)  â”‚ â”‚ â”‚ â”‚ â”œâ”€ Connect    â”‚ â”‚ â”‚ â”‚              â”‚ â”‚
        â”‚ â”‚ 3. Return        â”‚ â”‚ â”‚ â”‚ â”œâ”€ Listen to  â”‚ â”‚ â”‚ â”‚ 2. Preprocess
        â”‚ â”‚    task_id       â”‚ â”‚ â”‚ â”‚ â”‚  Redis      â”‚ â”‚ â”‚ â”‚              â”‚ â”‚
        â”‚ â”‚    (IMMEDIATE)   â”‚ â”‚ â”‚ â”‚ â”œâ”€ Relay to   â”‚ â”‚ â”‚ â”‚ 3. Fuse data â”‚ â”‚
        â”‚ â”‚                  â”‚ â”‚ â”‚ â”‚ â”‚  WebSocket  â”‚ â”‚ â”‚ â”‚   (Kalman)   â”‚ â”‚
        â”‚ â”‚ CHANGED: âœ…      â”‚ â”‚ â”‚ â”‚ â”‚  clients    â”‚ â”‚ â”‚ â”‚              â”‚ â”‚
        â”‚ â”‚ Before: task.get â”‚ â”‚ â”‚ â”‚ â””â”€ Auto-close â”‚ â”‚ â”‚ â”‚ 4. Calculate â”‚ â”‚
        â”‚ â”‚ (BLOCKING 10min) â”‚ â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ â”‚    ETo       â”‚ â”‚
        â”‚ â”‚                  â”‚ â”‚ â”‚ â”‚ UNCHANGED     â”‚ â”‚ â”‚ â”‚              â”‚ â”‚
        â”‚ â”‚ After: Return    â”‚ â”‚ â”‚ â”‚ (from 3.5.1) â”‚ â”‚ â”‚ â”‚ 5. Pub       â”‚ â”‚
        â”‚ â”‚ task_id          â”‚ â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ â”‚    progress  â”‚ â”‚
        â”‚ â”‚ (< 100ms)        â”‚ â”‚ â”‚ â”‚               â”‚ â”‚ â”‚ â”‚              â”‚ â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚                      â”‚ â”‚                   â”‚ â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                     â”‚                  â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                              (Redis pub/sub)
                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Redis - Message Broker                  â”‚
                    â”‚                                         â”‚
                    â”‚ Channel: task_{task_id}                 â”‚
                    â”‚ â”œâ”€ PROGRESS: step + progress %         â”‚
                    â”‚ â”œâ”€ SUCCESS: results                     â”‚
                    â”‚ â”œâ”€ ERROR: error message                 â”‚
                    â”‚ â””â”€ TIMEOUT: timeout info                â”‚
                    â”‚                                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Execution Timeline: Real-Time Calculation

```
Timeline (Minutes)    Frontend Status         Backend Status          WebSocket
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0:00  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ User clicks â”‚
      â”‚ "Calculate" â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚ POST /internal/eto/eto_calculate
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
             â”‚                              â”Œâ”€ Task queued
             â”‚                              â”‚ (Celery)
             â”‚                              â””â”€ Return task_id â† IMMEDIATE âœ…
             â”‚â—„â”€ {"task_id": "abc-123"}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
             â”‚ 
      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Open modal              â”‚          
      â”‚ PROCESSING, 5%          â”‚       task_id=abc-123 assigned
      â”‚ Create WebSocket        â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ WebSocket upgrade
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
             â”‚                              
             â”‚â—„â”€ Connect OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

0:05       â”‚                             â”Œâ”€ Start: Downloading data
           â”‚                             â”‚ Pub PROGRESS(25%)
           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€ Redis â†’ WS service
           â”‚ PROGRESS msg received       â”‚
      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
      â”‚ Step: "Downloading"   â”‚          â”‚
      â”‚ Progress: 25%         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ (ProgressCard updated)â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

0:10       â”‚                             â”Œâ”€ Preprocessing
           â”‚                             â”‚ Pub PROGRESS(50%)
           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€ Redis â†’ WS service
           â”‚ PROGRESS msg received       â”‚
      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
      â”‚ Step: "Preprocessing" â”‚          â”‚
      â”‚ Progress: 50%         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ (ProgressCard updated)â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

...
(Repeat every 2-3 seconds)
...

0:25       â”‚                             â”Œâ”€ Fusing data
           â”‚                             â”‚ Pub PROGRESS(75%)
           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€ Redis â†’ WS service
           â”‚ PROGRESS msg received       â”‚
      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
      â”‚ Step: "Fusing data"   â”‚          â”‚
      â”‚ Progress: 75%         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ (ProgressCard updated)â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5-10   â”‚                             â”Œâ”€ Computing ETo
:00    â”‚                             â”‚ Pub PROGRESS(95%)
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€ Redis â†’ WS service
       â”‚ PROGRESS msg received       â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
   â”‚ Step: "Computing"    â”‚          â”‚
   â”‚ Progress: 95%        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ (ProgressCard updated)â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

       â”‚                             â”Œâ”€ Task complete!
       â”‚                             â”‚ Pub SUCCESS(results)
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€ Redis â†’ WS service
       â”‚ SUCCESS msg received        â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚ Status: SUCCESS âœ…            â”‚  â”‚
   â”‚ Progress: 100%                â”‚  â”‚
   â”‚ Results table appears         â”‚â—„â”€â”˜
   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
   â”‚ â”‚ Date  â”‚ ETo   â”‚ Quality     â”‚  
   â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
   â”‚ â”‚ 2024- â”‚ 4.25  â”‚ HIGH        â”‚  
   â”‚ â”‚ 01-15 â”‚       â”‚             â”‚  
   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  
   â”‚ [Export] [Close]               â”‚  
   â”‚                                â”‚  
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  

       User clicks [Close]
             â”‚ Close modal
             â”‚ Call _ws_manager.disconnect()
             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
             â”‚
             â”‚ WebSocket closes
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## ğŸ”„ Message Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: Dash Callback Execution                                       â”‚
â”‚                                                                         â”‚
â”‚ Initial Call (User clicks button):                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ CASE 2: Calculate Button                                            â”‚â”‚
â”‚ â”‚                                                                      â”‚â”‚
â”‚ â”‚ 1. Extract location from State                                      â”‚â”‚
â”‚ â”‚ 2. POST /internal/eto/eto_calculate                                 â”‚â”‚
â”‚ â”‚ 3. Response: {"task_id": "abc-123"}                                 â”‚â”‚
â”‚ â”‚ 4. manager.connect_sync("abc-123")                                  â”‚â”‚
â”‚ â”‚    â””â”€ Spawns background thread                                      â”‚â”‚
â”‚ â”‚ 5. Create ProgressCard(status="PROCESSING")                         â”‚â”‚
â”‚ â”‚ 6. Return: (is_open=True, title, body, calc_state)                  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚ Repeated Calls (dcc.Interval every 2 seconds):                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ CASE 3: Interval Triggered                                          â”‚â”‚
â”‚ â”‚                                                                      â”‚â”‚
â”‚ â”‚ 1. manager.get_latest_message("abc-123")                            â”‚â”‚
â”‚ â”‚    â””â”€ Returns last msg from queue or None                           â”‚â”‚
â”‚ â”‚                                                                      â”‚â”‚
â”‚ â”‚ If message exists:                                                  â”‚â”‚
â”‚ â”‚    2. Extract: status, step, progress, results                      â”‚â”‚
â”‚ â”‚    3. Update calc_state dictionary                                  â”‚â”‚
â”‚ â”‚    4. Create new ProgressCard with updated data                     â”‚â”‚
â”‚ â”‚    5. Return: (is_open=True, title, body, calc_state)               â”‚â”‚
â”‚ â”‚                                                                      â”‚â”‚
â”‚ â”‚ If no message yet:                                                  â”‚â”‚
â”‚ â”‚    2. Return: (no_update, no_update, no_update, no_update)          â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚ Close Call (User clicks close button):                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ CASE 1: Close Modal                                                 â”‚â”‚
â”‚ â”‚                                                                      â”‚â”‚
â”‚ â”‚ 1. manager.disconnect("abc-123")                                    â”‚â”‚
â”‚ â”‚ 2. Return: (is_open=False, no_update, no_update, None)              â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Background: WebSocket Thread (One per connection)                       â”‚
â”‚                                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Thread Target: manager._connect_thread(task_id, on_message)        â”‚ â”‚
â”‚ â”‚                                                                    â”‚ â”‚
â”‚ â”‚ 1. Create asyncio event loop                                      â”‚ â”‚
â”‚ â”‚ 2. Call async _receive_messages()                                 â”‚ â”‚
â”‚ â”‚ 3. Connect: websockets.connect(ws_url)                            â”‚ â”‚
â”‚ â”‚    â””â”€ ws://localhost:8000/ws/task_status/abc-123                  â”‚ â”‚
â”‚ â”‚                                                                    â”‚ â”‚
â”‚ â”‚ 4. Listen for messages (async for loop):                          â”‚ â”‚
â”‚ â”‚    â”œâ”€ Receive JSON string from WebSocket                          â”‚ â”‚
â”‚ â”‚    â”œâ”€ Parse: json.loads(message_str)                              â”‚ â”‚
â”‚ â”‚    â”œâ”€ Create: WebSocketMessage(type=..., data=...)                â”‚ â”‚
â”‚ â”‚    â”œâ”€ Store: connections[task_id]['messages'].append(msg)         â”‚ â”‚
â”‚ â”‚    â”œâ”€ Call: on_message(msg) if callback provided                  â”‚ â”‚
â”‚ â”‚    â””â”€ Log: logger.debug(...)                                      â”‚ â”‚
â”‚ â”‚                                                                    â”‚ â”‚
â”‚ â”‚ 5. If SUCCESS/ERROR/TIMEOUT:                                      â”‚ â”‚
â”‚ â”‚    â”œâ”€ Break async loop                                            â”‚ â”‚
â”‚ â”‚    â”œâ”€ Update status: connections[task_id]['status'] = type        â”‚ â”‚
â”‚ â”‚    â””â”€ Close connection                                            â”‚ â”‚
â”‚ â”‚                                                                    â”‚ â”‚
â”‚ â”‚ 6. Exception handling:                                            â”‚ â”‚
â”‚ â”‚    â”œâ”€ ConnectionClosed: Log and close gracefully                  â”‚ â”‚
â”‚ â”‚    â”œâ”€ JSONDecodeError: Log and continue                           â”‚ â”‚
â”‚ â”‚    â””â”€ Other errors: Log and update status to 'error'              â”‚ â”‚
â”‚ â”‚                                                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Storage: WebSocketConnectionManager.connections                        â”‚
â”‚                                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ connections = {                                                     â”‚â”‚
â”‚ â”‚   "abc-123": {                                                      â”‚â”‚
â”‚ â”‚     "thread": <Thread object>,                                      â”‚â”‚
â”‚ â”‚     "messages": [                                                   â”‚â”‚
â”‚ â”‚       WebSocketMessage(                                             â”‚â”‚
â”‚ â”‚         type=PROGRESS,                                              â”‚â”‚
â”‚ â”‚         data={"step": "Downloading", "progress": 25}                â”‚â”‚
â”‚ â”‚       ),                                                             â”‚â”‚
â”‚ â”‚       WebSocketMessage(                                             â”‚â”‚
â”‚ â”‚         type=PROGRESS,                                              â”‚â”‚
â”‚ â”‚         data={"step": "Preprocessing", "progress": 50}              â”‚â”‚
â”‚ â”‚       ),                                                             â”‚â”‚
â”‚ â”‚       WebSocketMessage(                                             â”‚â”‚
â”‚ â”‚         type=SUCCESS,                                               â”‚â”‚
â”‚ â”‚         data={"results": [...], "warnings": []}                     â”‚â”‚
â”‚ â”‚       ),                                                             â”‚â”‚
â”‚ â”‚     ],                                                               â”‚â”‚
â”‚ â”‚     "status": "SUCCESS",                                            â”‚â”‚
â”‚ â”‚     "on_message": <callback function or None>                       â”‚â”‚
â”‚ â”‚   }                                                                  â”‚â”‚
â”‚ â”‚ }                                                                    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                         â”‚
â”‚ Accessed by:                                                           â”‚
â”‚ - manager.get_latest_message("abc-123")                                â”‚
â”‚   â†’ Returns: messages[-1] if messages else None                        â”‚
â”‚                                                                         â”‚
â”‚ - manager.get_messages("abc-123")                                      â”‚
â”‚   â†’ Returns: copy of messages list                                     â”‚
â”‚                                                                         â”‚
â”‚ - manager.get_status("abc-123")                                        â”‚
â”‚   â†’ Returns: status string                                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Thread Safety

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Concurrency Pattern: Threading + Locks                          â”‚
â”‚                                                                 â”‚
â”‚ Main Thread (Dash Callback)          Background Thread (WS)    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                 â”‚
â”‚ 1. User clicks button                                           â”‚
â”‚    manager.connect_sync(...)                                    â”‚
â”‚    â”œâ”€ Acquire lock                                              â”‚
â”‚    â”œâ”€ Create thread object                                      â”‚
â”‚    â”œâ”€ Store in connections dict                                 â”‚
â”‚    â”œâ”€ Release lock                                              â”‚
â”‚    â””â”€ Start thread                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Connect WebS â”‚
â”‚                                                   Acquire lock  â”‚
â”‚                                                   Listening...  â”‚
â”‚                                                   Release lock  â”‚
â”‚                                                                 â”‚
â”‚ 2. 2 seconds later                                              â”‚
â”‚    manager.get_latest_message(...)                              â”‚
â”‚    â”œâ”€ Acquire lock                                              â”‚
â”‚    â”œâ”€ Return messages[-1]             â—„â”€â”€â”€â”€â”€â”€ Simultaneously:  â”‚
â”‚    â””â”€ Release lock                           Receive message   â”‚
â”‚                                                Acquire lock     â”‚
â”‚                                                Store in queue   â”‚
â”‚                                                Release lock     â”‚
â”‚                                                                 â”‚
â”‚ 3. Update UI with message                                       â”‚
â”‚                                                                 â”‚
â”‚ Thread Lock (threading.Lock):                                   â”‚
â”‚ - Prevents simultaneous read/write                              â”‚
â”‚ - FIFO queue safety (only 1 thread writes)                      â”‚
â”‚ - Copy on read: return list.copy()                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ File Structure Summary

```
frontend/
â”œâ”€â”€ app.py (MODIFIED)
â”‚   â””â”€ Added: dcc.Store(calculation-state) + dcc.Interval
â”‚
â”œâ”€â”€ callbacks/
â”‚   â””â”€â”€ eto_callbacks.py (REFACTORED - 280 lines)
â”‚       â”œâ”€ calc_eto_today() - Main callback with WebSocket
â”‚       â””â”€ calc_eto_period() - Redirect callback
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ websocket_handler.py (NEW - 400+ lines)
â”‚   â”‚   â”œâ”€ WebSocketConnectionManager
â”‚   â”‚   â”œâ”€ WebSocketMessage
â”‚   â”‚   â””â”€ MessageType
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ progress_card.py (from 3.5.2)
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ pages/
    â”œâ”€â”€ dash_eto.py (CLEANED - removed duplicate store)
    â””â”€â”€ ...

backend/
â””â”€â”€ api/
    â”œâ”€â”€ routes/
    â”‚   â””â”€â”€ eto_routes.py (MODIFIED)
    â”‚       â””â”€ Changed: Return task_id instead of task.get()
    â”‚
    â””â”€â”€ websocket/
        â””â”€â”€ websocket_service.py (from 3.5.1 - unchanged)
```

---

## âœ… Validation Matrix

| Component | Type | Status | Lines | Purpose |
|-----------|------|--------|-------|---------|
| `eto_routes.py` | Backend | âœ… Modified | 10 changed | Return task_id immediately |
| `websocket_handler.py` | Frontend | âœ¨ Created | 400+ | Connection manager + threading |
| `eto_callbacks.py` | Frontend | âœï¸ Refactored | 280 (was 126) | WebSocket integration |
| `app.py` | Frontend | âœ… Modified | 2 new | Interval + Store |
| `progress_card.py` | Frontend | âœ… Existing | 530+ | UI components (from 3.5.2) |
| `dash_eto.py` | Frontend | âœ… Cleaned | 1 removed | Removed duplicate |

---

## ğŸ¯ Key Achievements

âœ… **Immediate Response**: API returns in < 100ms instead of blocking 5-10 minutes
âœ… **Real-Time Updates**: Progress visible every 2 seconds (via WebSocket)
âœ… **Threading**: Non-blocking WebSocket in background thread
âœ… **Thread Safety**: All shared data protected by locks
âœ… **Error Handling**: Comprehensive exception handling
âœ… **Auto Cleanup**: WebSocket disconnects automatically on completion
âœ… **Multiple Tasks**: Independent WebSocket connections per task
âœ… **User Experience**: Modal shows real progress instead of frozen state

---

**PHASE 3.5.3 Complete** âœ…

Next: **PHASE 3.5.4** - E2E Testing
